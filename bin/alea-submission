#!/usr/bin/env python
from argparse import ArgumentParser

from alea.submitters import SubmitterLocal, SubmitterSlurm, SubmitterHTCondor, NeymanConstructor


def main():
    parser = ArgumentParser("Submitter script for toyMCs in alea")
    # Required arguments
    parser.add_argument("running_config", type=str, help="YAML runner config file")
    parser.add_argument(
        "--computation",
        type=str,
        required=True,
        choices=[
            "discovery_power",
            "threshold",
            "sensitivity",
        ],
        help="Type of computation, defined in YAML runner config file",
    )
    # Exclusive groups on submission destination
    group = parser.add_mutually_exclusive_group(required=False)
    group.add_argument("--local", action="store_true", help="Executes the defined jobs locally")
    group.add_argument("--slurm", action="store_true", help="Prepare submission for slurm")
    group.add_argument(
        "--htcondor", action="store_true", help="Write out files for submission to htcondor"
    )
    # Optional arguments
    parser.add_argument(
        "--debug",
        action="store_true",
        help="Only 1 job will be prepared and its script will be printed out",
    )
    parser.add_argument(
        "--outputfolder",
        type=str,
        required=False,
        default=None,
        help="Overwriting the outputfolder, usually defined in runner config file",
    )
    parsed_args = parser.parse_args()

    if sum([parsed_args.slurm, parsed_args.htcondor, parsed_args.local]) != 1:
        raise ValueError(
            "You can only and must choose one of the following: --slurm, --htcondor, --local"
        )

    if parsed_args.slurm:
        destination = "slurm"
    elif parsed_args.htcondor:
        destination = "htcondor"
    elif parsed_args.local:
        destination = "local"
    kwargs = {
        "computation": parsed_args.computation,
        "debug": parsed_args.debug,
    }
    # if outputfolder is provided, overwrite the one in runner config file
    if parsed_args.outputfolder:
        kwargs["outputfolder"] = parsed_args.outputfolder

    if parsed_args.computation == "threshold":
        if destination != "local":
            raise ValueError("Threshold computation can only be done locally.")

    submitter_classes = {
        "slurm": SubmitterSlurm,
        "htcondor": SubmitterHTCondor,
        "local": SubmitterLocal if parsed_args.computation != "threshold" else NeymanConstructor,
    }

    submitter = submitter_classes[destination].from_config(parsed_args.running_config, **kwargs)

    submitter.submit()


if __name__ == "__main__":
    main()
